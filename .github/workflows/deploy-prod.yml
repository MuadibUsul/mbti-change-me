name: deploy-prod

on:
  push:
    branches: ["main", "master"]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      image: ${{ steps.meta.outputs.image }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Normalize GHCR owner
        id: owner
        run: echo "value=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')" >> "$GITHUB_OUTPUT"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Test
        run: npm run test

      - name: Build
        run: npm run build

      - name: Set image meta
        id: meta
        run: echo "image=ghcr.io/${{ steps.owner.outputs.value }}/mbtichange:${{ github.sha }}" >> "$GITHUB_OUTPUT"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ghcr.io/${{ steps.owner.outputs.value }}/mbtichange:${{ github.sha }}
            ghcr.io/${{ steps.owner.outputs.value }}/mbtichange:latest

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Deploy to Ubuntu host via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_SSH_PORT }}
          script_stop: true
          script: |
            set -euo pipefail

            APP_DIR="${{ secrets.SERVER_APP_DIR }}"
            IMAGE="${{ needs.build-and-push.outputs.image }}"
            APP_PORT="${{ secrets.APP_PORT }}"
            APP_NAME="${{ secrets.APP_NAME }}"
            BIND_HOST="${{ secrets.BIND_HOST }}"

            if [ -z "${APP_NAME:-}" ]; then
              APP_NAME="mbtichange"
            fi
            if [ -z "${BIND_HOST:-}" ]; then
              BIND_HOST="127.0.0.1"
            fi

            mkdir -p "$APP_DIR"
            cd "$APP_DIR"

            cat > docker-compose.prod.yml <<'YAML'
            services:
              db:
                image: postgres:16-alpine
                restart: unless-stopped
                environment:
                  POSTGRES_USER: ${DB_USER:-mbti}
                  POSTGRES_PASSWORD: ${DB_PASSWORD:-mbti-change-password}
                  POSTGRES_DB: ${DB_NAME:-mbtichange}
                volumes:
                  - postgres_data:/var/lib/postgresql/data
                healthcheck:
                  test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-mbti} -d ${DB_NAME:-mbtichange}"]
                  interval: 10s
                  timeout: 5s
                  retries: 10

              web:
                image: ${IMAGE}
                restart: unless-stopped
                env_file:
                  - .env.production
                depends_on:
                  db:
                    condition: service_healthy
                ports:
                  - "${BIND_HOST:-127.0.0.1}:${APP_PORT:-3001}:3000"
                healthcheck:
                  test: ["CMD", "wget", "-qO-", "http://127.0.0.1:3000/"]
                  interval: 30s
                  timeout: 5s
                  retries: 5

            volumes:
              postgres_data:
            YAML

            cat > .env.production <<'ENVFILE'
            ${{ secrets.APP_ENV }}
            ENVFILE

            set -a
            . ./.env.production
            set +a

            export IMAGE APP_PORT APP_NAME BIND_HOST
            export COMPOSE_PROJECT_NAME="${APP_NAME}"

            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin

            docker compose -f docker-compose.prod.yml up -d db
            docker compose -f docker-compose.prod.yml pull web
            docker compose -f docker-compose.prod.yml run --rm web npx prisma migrate deploy
            docker compose -f docker-compose.prod.yml up -d web
